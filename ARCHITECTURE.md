# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°

## ğŸ“ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Layer                         â”‚
â”‚  (Cursor / VSCode / Web App / CI/CD / Custom Integration)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ POST /llm-proxy
                     â”‚ {role, messages, user_id, project_id, ...}
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Supabase Edge Function                         â”‚
â”‚                    (llm-proxy)                               â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Request Validation                                â”‚  â”‚
â”‚  â”‚     - role, messages, user_id, project_id ãƒã‚§ãƒƒã‚¯    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. Rate Limiting                                     â”‚  â”‚
â”‚  â”‚     - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«QPMåˆ¶é™                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. Model Resolution                                  â”‚  â”‚
â”‚  â”‚     - model_map.json ã‚’å–å¾—                           â”‚  â”‚
â”‚  â”‚     - role â†’ {provider, model} ã«ãƒãƒƒãƒ”ãƒ³ã‚°           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4. LLM Provider Call                                 â”‚  â”‚
â”‚  â”‚     - OpenAI or Anthropic API å‘¼ã³å‡ºã—               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  5. Response Processing                               â”‚  â”‚
â”‚  â”‚     - ãƒˆãƒ¼ã‚¯ãƒ³æ•°å–å¾—                                  â”‚  â”‚
â”‚  â”‚     - ã‚³ã‚¹ãƒˆè¨ˆç®—                                      â”‚  â”‚
â”‚  â”‚     - PIIãƒã‚¹ã‚­ãƒ³ã‚°                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  6. Logging                                           â”‚  â”‚
â”‚  â”‚     - ai_api_logs ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI API   â”‚ â”‚Anthropicâ”‚ â”‚  Supabase    â”‚
â”‚              â”‚ â”‚  API    â”‚ â”‚  Postgres    â”‚
â”‚ - GPT-4o     â”‚ â”‚         â”‚ â”‚              â”‚
â”‚ - GPT-4o-miniâ”‚ â”‚- Claude â”‚ â”‚ ai_api_logs  â”‚
â”‚ - GPT-4-turboâ”‚ â”‚  Sonnet â”‚ â”‚   table      â”‚
â”‚              â”‚ â”‚- Claude â”‚ â”‚              â”‚
â”‚              â”‚ â”‚  Haiku  â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Supabase Storage â”‚
        â”‚                  â”‚
        â”‚ model_map.json   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼

### 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡

```
Client â†’ POST /llm-proxy
Headers:
  Content-Type: application/json
  Origin: https://app.cursor.sh (CORSç”¨)

Body:
  {
    "role": "backend",
    "messages": [...],
    "user_id": "taro",
    "project_id": "proj-123",
    ...
  }
```

### 2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
validateRequest(body) {
  âœ“ role ãŒå­˜åœ¨ã™ã‚‹ã‹
  âœ“ messages ãŒé…åˆ—ã§ã€ç©ºã§ãªã„ã‹
  âœ“ user_id ãŒå­˜åœ¨ã™ã‚‹ã‹
  âœ“ project_id ãŒå­˜åœ¨ã™ã‚‹ã‹
}
```

### 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯

```typescript
checkRateLimit(user_id, QPM) {
  - éå»1åˆ†é–“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  - QPMè¶…éã®å ´åˆ â†’ 429 Rate Limit Exceeded
}
```

### 4. ãƒ¢ãƒ‡ãƒ«è§£æ±º

```typescript
modelMap = await fetchModelMap(MODEL_MAP_URL)
modelConfig = modelMap[role] || modelMap._default

ä¾‹:
  role="backend" â†’ {provider: "anthropic", model: "claude-3-5-sonnet-20240620"}
  role="frontend" â†’ {provider: "openai", model: "gpt-4o-mini"}
```

### 5. LLM APIå‘¼ã³å‡ºã—

#### OpenAIã®å ´åˆ

```typescript
POST https://api.openai.com/v1/chat/completions
Headers:
  Authorization: Bearer ${OPENAI_API_KEY}
Body:
  {
    "model": "gpt-4o-mini",
    "messages": [...],
    "temperature": 0.7,
    "max_tokens": 2000
  }
```

#### Anthropicã®å ´åˆ

```typescript
POST https://api.anthropic.com/v1/messages
Headers:
  x-api-key: ${ANTHROPIC_API_KEY}
  anthropic-version: 2023-06-01
Body:
  {
    "model": "claude-3-5-sonnet-20240620",
    "messages": [...],
    "system": "...",  // systemãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    "max_tokens": 4096
  }
```

### 6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†

```typescript
// ãƒˆãƒ¼ã‚¯ãƒ³æ•°å–å¾—
tokens = extractTokens(provider, llmResponse)
  OpenAI: response.usage.{prompt_tokens, completion_tokens}
  Anthropic: response.usage.{input_tokens, output_tokens}

// ã‚³ã‚¹ãƒˆè¨ˆç®—
cost = calculateCost(provider, model, tokensIn, tokensOut)

// PIIãƒã‚¹ã‚­ãƒ³ã‚°
maskedPrompt = maskPII(prompt, LOG_MASK_PII)
  - ãƒ¡ãƒ¼ãƒ«: xxx@yyy.com â†’ [EMAIL]
  - é›»è©±: 090-1234-5678 â†’ [PHONE]
  - ç•ªå·: 1234567890123456 â†’ [NUMBER]
```

### 7. ãƒ­ã‚°ä¿å­˜

```typescript
INSERT INTO ai_api_logs (
  user_id,
  project_id,
  provider,
  model,
  prompt,
  response,
  tokens_in,
  tokens_out,
  cost_usd,
  meta
) VALUES (...)
```

### 8. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

```json
{
  "provider": "anthropic",
  "model": "claude-3-5-sonnet-20240620",
  "data": {
    "id": "msg_...",
    "content": [...],
    "usage": {...}
  }
}
```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼

### èªè¨¼ãƒ»èªå¯

```
ç¾åœ¨: ãªã—ï¼ˆå°†æ¥å®Ÿè£…äºˆå®šï¼‰
å°†æ¥: JWTèªè¨¼ã€user_idç½²åæ¤œè¨¼
```

### API Keyç®¡ç†

```
Supabase Secrets (ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æš—å·åŒ–ä¿å­˜)
â”œâ”€ OPENAI_API_KEY
â”œâ”€ ANTHROPIC_API_KEY
â””â”€ ãã®ä»–ã®Secret
```

### CORSåˆ¶å¾¡

```typescript
ALLOW_ORIGINS ç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡
- æœ¬ç•ª: ç‰¹å®šãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿è¨±å¯
- é–‹ç™º: * ï¼ˆå…¨è¨±å¯ï¼‰ã‚‚å¯
```

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```typescript
ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…
- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã”ã¨ã«éå»1åˆ†é–“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡
- QPMï¼ˆQueries Per Minuteï¼‰ã§åˆ¶é™

å°†æ¥: Redisç­‰ã®å¤–éƒ¨ã‚¹ãƒˆã‚¢ã§ç®¡ç†
```

### PIIãƒã‚¹ã‚­ãƒ³ã‚°

```typescript
æ­£è¦è¡¨ç¾ã§ãƒã‚¹ã‚­ãƒ³ã‚°ï¼ˆè»½å¾®ãªå®Ÿè£…ï¼‰
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- é›»è©±ç•ªå·
- é€£ç¶šã™ã‚‹æ•°å­—ï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç­‰ï¼‰

å°†æ¥: ã‚ˆã‚Šé«˜åº¦ãªPIIæ¤œå‡ºï¼ˆNLPç­‰ï¼‰
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### ai_api_logs ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE ai_api_logs (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  ts          timestamptz NOT NULL DEFAULT now(),
  user_id     text,
  project_id  text,
  provider    text CHECK (provider IN ('openai','anthropic')),
  model       text,
  prompt      text,        -- PIIãƒã‚¹ã‚­ãƒ³ã‚°æ¸ˆã¿
  response    jsonb,       -- LLM APIã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹
  tokens_in   int,
  tokens_out  int,
  cost_usd    numeric(12,4),
  meta        jsonb        -- toolåãªã©è¿½åŠ æƒ…å ±
);
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
- ts (æ™‚ç³»åˆ—ã‚¯ã‚¨ãƒªç”¨)
- (project_id, provider) (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥åˆ†æç”¨)
- user_id (ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥åˆ†æç”¨)
```

## ğŸ›ï¸ è¨­å®šç®¡ç†

### model_map.json (å‹•çš„è¨­å®š)

```json
{
  "roleå": {
    "provider": "openai" | "anthropic",
    "model": "ãƒ¢ãƒ‡ãƒ«å"
  },
  "_default": { ... }  // å¿…é ˆ
}
```

**ç‰¹å¾´:**
- å†ãƒ‡ãƒ—ãƒ­ã‚¤ä¸è¦ã§å¤‰æ›´å¯èƒ½
- Supabase Storageã‹ã‚‰å–å¾—
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼ˆæ¯å›å–å¾—ï¼‰

**å°†æ¥æ”¹å–„:**
- ã‚¨ãƒƒã‚¸ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆTTLä»˜ãï¼‰
- ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°

### ç’°å¢ƒå¤‰æ•° (é™çš„è¨­å®š)

```bash
OPENAI_API_KEY      # OpenAI APIã‚­ãƒ¼
ANTHROPIC_API_KEY   # Anthropic APIã‚­ãƒ¼
SUPABASE_URL        # Supabaseæ¥ç¶šURL
SUPABASE_ANON_KEY   # SupabaseåŒ¿åã‚­ãƒ¼
MODEL_MAP_URL       # model_map.jsonã®URL
LOG_MASK_PII        # PIIãƒã‚¹ã‚­ãƒ³ã‚°æœ‰åŠ¹åŒ–
RATE_LIMIT_QPM      # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆQPMï¼‰
ALLOW_ORIGINS       # CORSè¨±å¯ã‚ªãƒªã‚¸ãƒ³
```

## ğŸ”„ æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

### 1. RAGçµ±åˆ

```typescript
// ãƒ™ã‚¯ãƒˆãƒ«DBã‹ã‚‰é–¢é€£æƒ…å ±ã‚’å–å¾—
context = await vectorDB.search(query)

// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
messages.unshift({
  role: "system",
  content: `ä»¥ä¸‹ã®æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„: ${context}`
})
```

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```typescript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
cacheKey = hash({role, messages, temperature, ...})

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
if (cached = await cache.get(cacheKey)) {
  return cached
}

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ã®å ´åˆã€LLMå‘¼ã³å‡ºã—å¾Œã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
response = await callLLM(...)
await cache.set(cacheKey, response, TTL)
```

### 3. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼ˆSSEï¼‰

```typescript
// OpenAI/Anthropicå…±ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ
stream = await callLLMStream(...)

// SSEã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡
for await (const chunk of stream) {
  writer.write(`data: ${JSON.stringify(chunk)}\n\n`)
}
```

### 4. ã‚³ã‚¹ãƒˆè‡ªå‹•è¨ˆç®—ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

```sql
-- ã‚³ã‚¹ãƒˆé›†è¨ˆãƒ“ãƒ¥ãƒ¼
CREATE VIEW daily_costs AS
SELECT 
  DATE(ts) as date,
  project_id,
  SUM(cost_usd) as total_cost
FROM ai_api_logs
GROUP BY DATE(ts), project_id;

-- ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆé–¢æ•°ãƒˆãƒªã‚¬ãƒ¼ï¼‰
CREATE FUNCTION check_cost_threshold() ...
```

## ğŸš€ AWSç§»è¡Œæ™‚ã®å¯¾å¿œ

### ç¾åœ¨ï¼ˆSupabaseï¼‰

```
Edge Function (Deno)
  â†“
Supabase Storage (model_map.json)
  â†“
Supabase Postgres (logs)
```

### å°†æ¥ï¼ˆAWSï¼‰

```
API Gateway
  â†“
Lambda (Node.js/Python)
  â†“
S3 (model_map.json)
  â†“
DynamoDB or S3 (logs)
  â†“
Secrets Manager (API Keys)
```

**ç§»è¡Œæ™‚ã®ãƒã‚¤ãƒ³ãƒˆ:**
- åŒã˜I/Fï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰ã‚’ç¶­æŒ
- åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã‚‚åŒæ§˜ï¼‰
- ç’°å¢ƒå¤‰æ•°åã‚‚åŒã˜

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·

```
Edge Functionèµ·å‹•: ~50ms
model_map.jsonå–å¾—: ~100ms
LLM APIå‘¼ã³å‡ºã—: 1000-5000ms (ãƒ¢ãƒ‡ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã«ã‚ˆã‚‹)
ãƒ­ã‚°ä¿å­˜: ~50ms (éåŒæœŸ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åˆè¨ˆ: ~1200-5200ms
```

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

```
Supabase Edge Function: è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«
åˆ¶é™: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã§åˆ¶å¾¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60QPM/ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
```

### ã‚³ã‚¹ãƒˆæœ€é©åŒ–

```
1. è·ç¨®ã«å¿œã˜ã¦å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
   - QA â†’ Claude Haiku (å®‰ä¾¡)
   - Backend â†’ Claude Sonnet (é«˜æ€§èƒ½)
   
2. max_tokensã‚’é©åˆ‡ã«è¨­å®š
   
3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥ã§é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šæ¸›
```

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **ãƒ­ãƒ¼ãƒ«è¨­è¨ˆ**: è·ç¨®ãƒ»ç”¨é€”ã«å¿œã˜ãŸç´°ã‹ã„ãƒ­ãƒ¼ãƒ«å®šç¾©
2. **ãƒ¢ãƒ‡ãƒ«é¸æŠ**: ã‚³ã‚¹ãƒˆã¨æ€§èƒ½ã®ãƒãƒ©ãƒ³ã‚¹
3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: é©åˆ‡ãªQPMè¨­å®š
4. **ãƒ­ã‚°åˆ†æ**: å®šæœŸçš„ãªã‚³ã‚¹ãƒˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
5. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æœ¬ç•ªç’°å¢ƒã§ã¯CORSåˆ¶é™ã‚’å³æ ¼ã«

